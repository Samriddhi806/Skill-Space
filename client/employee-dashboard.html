<!DOCTYPE html>
<html>
<head>
  <title>Employee Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="navbar">
    <h1>Employee Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </header>

  
  <div class="stats-grid" style="display:flex; gap:20px; margin:20px 0; padding:0 20px;">
    <div style="background:#eff6ff; padding:20px; border-radius:12px; flex:1; text-align:center;">
      <h3 style="color:#2563eb; margin:0 0 10px 0;">Tests Available</h3>
      <span id="tests-available" style="font-size:28px; font-weight:bold; color:#1e40af;">0</span>
    </div>
    <div style="background:#f0fdf4; padding:20px; border-radius:12px; flex:1; text-align:center;">
      <h3 style="color:#059669; margin:0 0 10px 0;">Tests Completed</h3>
      <span id="tests-completed" style="font-size:28px; font-weight:bold; color:#166534;">0</span>
    </div>
  </div>

  <main class="page">
    <section class="dashboard-grid">
      <div class="card">
        <h3>My Assigned Tests</h3>
        <ul id="myTasks" class="task-list"></ul>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <p style="font-size:14px; color:#6b7280; margin-bottom:8px;">
          Click "Take Test" to start any assigned assessment.
        </p>
        <p style="font-size:13px; color:#9ca3af;">
          Tests are automatically scored and added to leaderboards.
        </p>
      </div>
    </section>
  </main>

  <script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token || role !== "employee") {
      window.location = "login.html";
    }

    function logout() {
      localStorage.clear();
      window.location = "login.html";
    }

    // NEW: Take test function
    function takeTest(testId) {
      window.location.href = `test.html?id=${testId}`;
    }

    // UPDATED: Load assigned tests + stats
    async function loadMyTasks() {
      try {
        // Get assigned tests
        const tasksRes = await fetch("http://localhost:3000/api/tasks/assigned/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        const assignedTests = await tasksRes.json();
        
        // Get completed tests count
        const resultsRes = await fetch("http://localhost:3000/api/results/my", {
          headers: { "Authorization": "Bearer " + token }
        });
        const completedTests = await resultsRes.json();

        // Update stats
        document.getElementById('tests-available').textContent = assignedTests.length;
        document.getElementById('tests-completed').textContent = completedTests.length;

        // Display assigned tests
        const ul = document.getElementById("myTasks");
        ul.innerHTML = "";
        
        assignedTests.forEach(t => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div>
              <strong style="color:#1f2937;">${t.test.title}</strong>
              <span style="color:#10b981; font-weight:bold; margin-left:10px;">üìù Test</span><br>
              <small style="color:#6b7280;">
                ${t.test.description?.substring(0,60) || 'No description'}...
              </small><br>
              <small style="color:#9ca3af;">Assigned: ${new Date(t.assigned_at).toLocaleDateString()}</small>
            </div>
            <div class="task-actions">
              <button onclick="takeTest('${t.test._id}')" 
                      style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
                Take Test
              </button>
            </div>`;
          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.alignItems = "center";
          li.style.padding = "12px";
          li.style.borderBottom = "1px solid #e5e7eb";
          ul.appendChild(li);
        });

        if (assignedTests.length === 0) {
          ul.innerHTML = '<li style="text-align:center; color:#6b7280; padding:40px;">No tests assigned yet</li>';
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById("myTasks").innerHTML = '<li style="color:#ef4444;">Error loading tests</li>';
      }
    }

    
    loadMyTasks();
  </script>
</body>

</html>
